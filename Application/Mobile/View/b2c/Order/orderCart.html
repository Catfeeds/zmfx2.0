<include file="Public:header" />
<body>
    <section class="cart">

        <!-- top -->
        <header>
            <div class="web-top">
                <div class="back-box">
                    <img src="__IMG__/back_icon.png" onclick="history.back(-1)" class="back-img" alt="">
                </div>
                <h2>购物车</h2>
                <div class="web-top-right">
                    <span class="cart-edit">编辑</span>
                </div>
            </div>
        </header>
        <!-- top end -->
 
        <section class="cart-list wrapper">
			<?php if($luozuan): ?>
				<?php foreach($luozuan['data'] as $val):?>
						<div class="goods-item luozhuan-item" attr_id='<?php echo ($val['id']);?>' attr_type='<?php echo ($val['goods_type']);?>'>
							<div class="head"><input type="checkbox" class="zdy-checkbox" name="" value=""> 【<?php echo ($val['goods_type']) ? '彩钻' : '白钻';?>】编号:<?php echo $val['goods_sn'];?></div>
							<div class="goods-layout clearfix">
								<div class="goods-right">
									<h2>
										形状：<?php echo $val['goods_attrs']['shape_name'];?>    重量：<?php echo $val['goods_attrs']['weight'];?>ct    颜色：<?php echo $val['goods_attrs']['color'];?>    净度：<?php echo $val['goods_attrs']['clarity'];?>
										切工：<?php echo $val['goods_attrs']['cut'];?>     		 抛光：<?php echo $val['goods_attrs']['polish'];?>      对称：<?php echo $val['goods_attrs']['symmetry'];?>
									</h2>
									<p class="goods-title"><?php echo $val['certificate_type'];?> <?php echo $val['certificate_number'];?></p>
									<div class="goods-fangshi clearfix">
										<span class="fl c9 rmb">￥<span class="price"><?php echo $val['goods_attrs']['price'];?></span></span>
										<span class="fr">
											<div class="customize-box">
												<a href="javascript:;" class="reduction"><img src="__IMG__/reduction_icon.png" alt=""></a>
												<input type="text" name="" onkeyup="value=value.replace(/[^\d]/g,'')" value="<?php echo intval($val['goods_number']);?>" min="1" class="number-cust">
												<a href="javascript:;" class="add"><img src="__IMG__/add_icon.png" alt=""></a>
												<div class="clearfix"></div>
											</div>
										</span>
									</div>
								</div>
							</div>
						</div>
				<?php endforeach;?>
			<?php endif; ?>

            <!-- 祼钻 end -->

 
            <!-- 匹配 -->
			<?php if($product): ?>
				<?php foreach($product['data'] as $val):?>
	 
					<div class="goods-item" attr_id='<?php echo ($val['id']);?><?php if($val['pp_luozuan']['stopgap_id']){	echo ','.implode(',',$val['pp_luozuan']['stopgap_id']);	};?>' attr_type='<?php echo ($val['goods_type']);?>'>
						<div class="head"><input type="checkbox" class="zdy-checkbox" name="" value="">【<?php echo ($val['goods_type']==4) ? '定制' : '成品';?>】编号：<?php echo $val['goods_attrs']['goods_sn'];?></div>
						<div class="goods-layout mb0 border-bottom clearfix">
							<div class="goods-img">
								<a href="/Goods/detail/goods_type/<?php echo $val['goods_type'];?>/gid/<?php echo $val['goods_id'];?>"><img src="<?php echo $val['goods_attrs']['thumb'];?>" alt=""></a>
							</div>
							<div class="goods-right">
								<h2><a href="/Goods/detail/goods_type/<?php echo $val['goods_type'];?>/gid/<?php echo $val['goods_id'];?>"><?php echo $val['goods_attrs']['goods_name'];?></a></h2>
								<p class="goods-title">颜色:<?php echo $val['goods_attrs']['associateInfo']['material_name'];?>+<?php echo $val['goods_attrs']['luozuanInfo']['shape_name'];?></p>
								<div class="goods-fangshi clearfix">
									<span class="fl c9 rmb">￥<span class="price">
									<in name="val['goods_attrs']['activity_status']" value="0,1">
										{$val['goods_attrs']['activity_price']}
									<else/>
										{$val['goods_attrs']['goods_price']}
									</in>
									</span></span>
									
									<?php if(!$val['pp_luozuan']): ?>
									        <span class="fr">
												<div class="customize-box">
													<a href="javascript:;" class="reduction"><img src="__IMG__/reduction_icon.png" alt=""></a>
													<input type="text" name="" value="<?php echo intval($val['goods_number']);?>" onkeyup="value=value.replace(/[^\d]/g,'')" min="1" class="number-cust">
													<a href="javascript:;" class="add"><img src="__IMG__/add_icon.png" alt=""></a>
													<div class="clearfix"></div>
												</div>
											</span>
									<?php endif; ?>			
								</div>
							</div>
						</div>
						<!-- 祼钻 -->
						
						<?php if($val['pp_luozuan']): ?>
							<?php foreach($val['pp_luozuan'] as $key=>$val):?>
								<?php if(is_numeric($key)):?>
									<div class="luozhuan-item pipei-goods">
										<div class="head">【<?php echo ($val['goods_type']) ? '彩钻' : '白钻';?>】编号:<?php echo $val['goods_sn'];?></div>
										<div class="goods-layout clearfix">
											<div class="goods-right">
												<h2>
													形状：<?php echo $val['goods_attrs']['shape_name'];?>    重量：<?php echo $val['goods_attrs']['weight'];?>ct    颜色：<?php echo $val['goods_attrs']['color'];?>     净度：<?php echo $val['goods_attrs']['clarity'];?>
													切工：<?php echo $val['goods_attrs']['cut'];?>     		 抛光：<?php echo $val['goods_attrs']['polish'];?>      对称：<?php echo $val['goods_attrs']['symmetry'];?>
												</h2>
												<p class="goods-title"><?php echo $val['certificate_type'];?> <?php echo $val['certificate_number'];?></p>
												<div class="goods-fangshi clearfix">
													<span class="fl c9 rmb">￥<span class="pipei-price"><?php echo $val['goods_attrs']['price'];?></span></span>
													<span class="fr">
														<div class="customize-box">
															<a href="javascript:;" class="reduction"><img src="__IMG__/reduction_icon.png" alt=""></a>
															<input type="text" name="" onkeyup="value=value.replace(/[^\d]/g,'')" value="<?php echo intval($val['goods_number']);?>" min="1" class="number-cust">
															<a href="javascript:;" class="add"><img src="__IMG__/add_icon.png" alt=""></a>
															<div class="clearfix"></div>
														</div>
													</span>
												</div>
											</div>
										</div>
									</div>
								<?php endif; ?>
							<?php endforeach;?>
						<?php endif; ?>
						<!-- 祼钻 end -->
					</div>
				<?php endforeach;?>
			<?php endif; ?>			
            <!-- 匹配 end -->
 
			
 
            <!-- 空购物车 -->
            <div class="empty-cart" style="<?php echo ($count) ? 'display: none;' : ''; ?>">
                <p><img src="__IMG__/empty_cart.png" alt="" class="empty-img"></p>
                <p>
                    <h2>您的购物车空空如也~~</h2>
                </p>
                <p><a href="/" class="toindex">去首页</a></p>
            </div>
            <!-- 空购物车 end -->

            <!-- 结算 -->
            <style>
                body { margin-bottom: 4.8rem !important;}
            </style>
            <div class="settlement">
                <input type="checkbox" id="check-all" class="zdy-checkbox" name="" value="">
                <label for="check-all" class="mr">全选</label> <span class="rmb total-box">合计:￥<span class="total-price">0.00</span></span>
                <a  class="set-btn" id="settlement-btn">去结算(<span class="sum">0</span>)</a>
                <a  class="set-btn" id="removeData" style="display: none;">删除(<span class="sum">0</span>)</a>
            </div>
            <!-- 结算 end -->
        </section>
        <script>
            $(function(){
                /*
                 * @author: songjingwen;
                 * @date: 2017-8-1;
                 * 实现购物车交互功能：
                 * 1.全选、反选计算改变商品数量和价格
                 * 2.单选计算改变商品数量和价格
                 * 3.监听删除商品后改变商品数量
                 * 4.监听单个商品改变数量后计算改变商品数量和价格
                 * 5.监听商品状态
                 */
				 
				var SessionMark ='<?php echo count($_SESSION['m']);?>' 

				var ChangeNumberCondition = {
								'cart_id': '',
								'goods_number':'',
								'Url':'/Order/changeGoodsNumber',
								'goods_type':''
				}

				var DeleteCartCondition = {
								'cart_ids': '',
								'type':2,
								'Url':'/Order/deleteCart',
				}				
				 
				 
                var cart = {
                    //计算价格
                    price: function(){
                        var price = 0;
                        $('.goods-item').each(function(){
                            if($(this).find('.zdy-checkbox').prop('checked')){
                                var cust = parseFloat($(this).find('.number-cust').val());
                                var pipei = parseFloat($(this).find('.luozhuan-item').find('.pipei-price').html());
                                price = price + parseFloat($(this).find('.price').html() * cust);
                                pipei ? price = price + (pipei * cust) : ''; //如果为匹配商品就加上匹配到商品的价格
                            }
                        });
                        $('.total-price').html(price.toFixed(2));
                    },
                    //计算商品数量
                    goodsNumber: function(){
                        var lengths = 0;
                        $('.goods-item').each(function(){
                            if($(this).find('.zdy-checkbox').prop('checked')){
                                lengths = lengths + parseInt($(this).find('.number-cust').val());
                            }
                        });
                        $('.sum').html(lengths);

                        //如果商品全不选后改变全选按钮为取消状态
                        if(lengths == 0){
                            reset.checkboxAllFalse();
                        }

                        //5.监听商品状态：商品全部被选择后联动全选按钮
                        var len = $('.goods-item').length;
                        if(len == lengths){
                            $('#check-all').prop('checked', true);
                            reset.checkbox('#check-all');
                        }
						

                    },
                    //删除购物车商品
                    removeGoods: function(){
                        var sum = 0;
						var cart_ids = '';
                        //获取选择商品数量
                        $('.goods-item').each(function(){
                            if($(this).find('.zdy-checkbox').prop('checked')){
                                sum   	  += parseInt($(this).find('.number-cust').val());
								cart_ids  += $(this).attr('attr_id')+',';
                            }
                        });
						

                        if(sum >= 1){
                            layer.open({
                                content: '确定要删除这'+ sum +'件宝贝吗？'
                                ,btn: ['确定', '取消']
                                ,yes: function(index){
									DeleteCartCondition.cart_ids 		= 	StringManage.LTrim(cart_ids);
									MiddleLayer(DeleteCartCondition,function(data){
										ThreeAjax.tan(data.msg);
										//删除商品
										$('.goods-item').each(function(){
											if($(this).find('.zdy-checkbox').prop('checked')){
												$(this).remove();
												cart.goodsNumber();
												//判断购物车是否有商品，没有则显示购物车为空
												if($('.goods-item').length <= 0){
													$('.empty-cart').show();
													$('.settlement').hide();
													cart.editCart();
												}else {
													$('.settlement').show();
													$('.empty-cart').hide();
												}
											}
										});
										layer.close(index);				 
									},'msg');
                                }
                            });
                        }else{
                            layer.open({
                                content: '请选择商品'
                                ,btn: ['确定']
                            });
                        }
                    },
                    //编辑购物车
                    editCart: function(){
                        if($('.cart-edit').attr('data') == 'edit'){
                            reset.checkboxAll();//设置全选
                            $('.cart-edit').html('编辑');
                            $('.cart-edit').attr('data', '');
                            $('#settlement-btn, .total-box').show();
                            $('#removeData').hide();
                        }else{
                            reset.checkboxAllFalse();//设置全不选
                            $('.cart-edit').html('完成');
                            $('.cart-edit').attr('data', 'edit');
                            $('#settlement-btn, .total-box').hide();
                            $('#removeData').show();
                        }
                    }
                }

                //1.全选、反选计算改变商品数量和价格
                $(document).delegate('#check-all', 'change', function(){
                    cart.goodsNumber();
                    cart.price();
                });

                //2.单选计算改变商品数量和价格
                $('.goods-item').each(function(){
                    $(this).find('.zdy-checkbox').change(function(){
                        //5.监听商品状态：全选情况下如果有某个商品取消选择则联动全选按钮为取消状态
                        if(!$(this).find('.zdy-checkbox').prop('checked')){
                            $('#check-all').prop('checked', false);
                            reset.checkbox('#check-all');
                        }
                        cart.goodsNumber();
                        cart.price();
                    });
                });

                //3.删除商品后改变商品数量
                $('#removeData').bind('click', function(){
                    cart.removeGoods();
                });

                /*
                 * 商品数量选择					layer.open({	 content: data.msg})		
                 * 4.单个商品改变数量后计算改变商品数量和价格
                 */
                $('.customize-box').each(function(){
                    var str   = $(this).find('.number-cust');
					var _this =  $(this);
                    //加
                    $(this).find('.add').bind('click', function(){
						ChangeNumberCondition.cart_id 		= $(this).parents('.goods-item').attr('attr_id');
						ChangeNumberCondition.goods_number 	= parseInt(str.val())+1;
						ChangeNumberCondition.goods_type 	= $(this).parents('.goods-item').attr('attr_type');
						MiddleLayer(ChangeNumberCondition,function(data){
							str.val( parseInt(str.val())+1 );
							cart.goodsNumber();
							cart.price();					 
						},'msg');
                    });
                    //减
                    $(this).find('.reduction').bind('click', function(){
                        if(str.val() > 1){
							ChangeNumberCondition.cart_id 		= $(this).parents('.goods-item').attr('attr_id');
							ChangeNumberCondition.goods_number 	= parseInt(str.val())-1;
							ChangeNumberCondition.goods_type 	= $(this).parents('.goods-item').attr('attr_type');
							MiddleLayer(ChangeNumberCondition,function(data){
								str.val( parseInt(str.val())-1 );
								cart.goodsNumber();
								cart.price();					 
							},'msg');
                        }
                    });

                    //监听单件商品数量变化
                    $(this).find('.number-cust').blur(function(){
						if($(this).val() > 1){
							ChangeNumberCondition.cart_id 		= $(this).parents('.goods-item').attr('attr_id');
							ChangeNumberCondition.goods_number 	= parseInt(str.val())-1;
							ChangeNumberCondition.goods_type 	= $(this).parents('.goods-item').attr('attr_type');
							MiddleLayer(ChangeNumberCondition,function(data){
								cart.goodsNumber();
								cart.price();				 
							},'msg');
						}						 
							
					
					
                        if($(this).val() == ''){
							$(this).val(1);
							cart.goodsNumber();
							cart.price();
                        }
                    });
                });

                //编辑购物车按钮		
                $('.cart-edit').bind('click', function(){
                    cart.editCart();
                    cart.goodsNumber();
                    cart.price();
                });

                /**
                 * 初始化：
                 * 1.reset.checkboxAll() //默认全选商品
                 * 2.cart.goodsNumber() //计算己选择商品数量
                 * 3.cart.price()       //计算己选择商品价格
                 */
                reset.checkboxAll();
                cart.goodsNumber();
                cart.price();

				
				
                $('#settlement-btn').bind('click', function(){
					var cart_ids ='';
					if(SessionMark=='0'){
						ThreeAjax.tan('请先登录，在提交订单！');
						setTimeout("window.location.href='/Public/login.html'",3000);
					}else{
					    //获取当前选择ID
                        $('.goods-item').each(function(){
                            if($(this).find('.zdy-checkbox').prop('checked')){
								cart_ids  += $(this).attr('attr_id')+',';
                            }
                        });
						
						if(cart_ids!=''){
							window.location.href='/Order/orderConfirm?id='+ThreeAjax.JsB64(StringManage.LTrim(cart_ids));
						}else{
							ThreeAjax.tan('请先选择要提交订单的商品！');
						}
						
					}
                });				
				
				
				
            });
        </script>
    </section>

<style>
    body { margin-bottom: 2.2rem;}
</style>

<include file="Public:tabs" />
<include file="Public:foot" />
</body>
</html>
